# -*- coding: utf-8 -*-
"""promotion_dashboard.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gS8ErtzyrfIFxUHAYSRUfcTmYD_CZJUv
"""

# ------------------------------------------------------------
# ğŸ¯ HR Promotions Dashboard (Works only with Final_Promotions_Predicted_Dataset.csv)
# ------------------------------------------------------------

import streamlit as st
import pandas as pd
import plotly.express as px
import os

st.set_page_config(page_title="HR Promotions Dashboard", layout="wide")
st.title("ğŸ“Š HR Promotions Analytics Dashboard")

# ------------------------------------------------------------
# Load Dataset (specific to user's uploaded file)
# ------------------------------------------------------------
@st.cache_data
def load_data():
    file_name = "Final_Promotions_Predicted_Dataset.csv"
    if not os.path.exists(file_name):
        st.error(f"âŒ File '{file_name}' not found. Place the CSV in the same folder as dashboard.py")
        st.stop()
    return pd.read_csv(file_name)

df = load_data()

# Rename 0/1 values to Yes/No to improve readability
if "Promotion" in df.columns:
    df["Promotion"] = df["Promotion"].map({1: "Yes", 0: "No"})
if "Prediction" in df.columns:
    df["Prediction"] = df["Prediction"].map({1: "Yes", 0: "No"})

# ------------------------------------------------------------
# Filters
# ------------------------------------------------------------
st.sidebar.header("ğŸ” Filter Data")
d_filter = st.sidebar.multiselect("Filter by Department", df["Department"].unique())
g_filter = st.sidebar.multiselect("Filter by Gender", df["Gender"].unique())

filtered = df.copy()
if d_filter:
    filtered = filtered[filtered["Department"].isin(d_filter)]
if g_filter:
    filtered = filtered[filtered["Gender"].isin(g_filter)]

# ------------------------------------------------------------
# KPI Cards
# ------------------------------------------------------------
col1, col2, col3, col4 = st.columns(4)
col1.metric("Total Employees", len(filtered))
col2.metric("Actual Promotion %", f"{(filtered['Promotion'].eq('Yes').mean() * 100):.2f}%")
col3.metric("Predicted Promotion %", f"{(filtered['Prediction'].eq('Yes').mean() * 100):.2f}%")
col4.metric("Mismatch count", sum(filtered["Promotion"] != filtered["Prediction"]))

st.markdown("---")

# ------------------------------------------------------------
# ğŸ”¥ Visuals
# ------------------------------------------------------------

st.subheader("ğŸ“Œ Employee Count by Department")
st.plotly_chart(px.bar(filtered, x="Department", title="Employee Count"), use_container_width=True)

st.subheader("ğŸ“Œ Gender Distribution by Department")
st.plotly_chart(
    px.histogram(filtered, x="Department", color="Gender", barmode="group",
                 title="Gender Distribution Across Departments"),
    use_container_width=True,
)

st.subheader("ğŸ“Œ Actual Promotion by Department")
st.plotly_chart(
    px.histogram(filtered, x="Department", color="Promotion", barmode="group",
                 title="Actual Promotions by Department"),
    use_container_width=True,
)

st.subheader("ğŸ“Œ Predicted Promotion by Department")
st.plotly_chart(
    px.histogram(filtered, x="Department", color="Prediction", barmode="group",
                 title="Predicted Promotions by Department"),
    use_container_width=True,
)

# 5 â€” Heatmap only if probability column exists
if "Promotion_Probability" in filtered.columns:
    st.subheader("ğŸ“Œ Promotion Probability Heatmap")
    st.plotly_chart(
        px.density_heatmap(
            filtered,
            x="Satisfaction",
            y="PerformanceScore",
            z="Promotion_Probability",
            title="Probability Distribution for Promotion",
        ),
        use_container_width=True,
    )

# 6 â€” Actual vs Predicted Promotion % by Department
st.subheader("ğŸ“Œ Actual vs Predicted Promotion % â€” Department Level")
compare = filtered.groupby("Department")[["Promotion", "Prediction"]].apply(
    lambda x: pd.Series({
        "Actual %": x["Promotion"].eq("Yes").mean() * 100,
        "Predicted %": x["Prediction"].eq("Yes").mean() * 100
    })
).reset_index()

st.plotly_chart(
    px.bar(compare, x="Department", y=["Actual %", "Predicted %"],
           barmode="group", title="Actual vs Predicted Promotion Comparison"),
    use_container_width=True,
)

st.markdown("---")

# ------------------------------------------------------------
# Table + Download
# ------------------------------------------------------------
st.subheader("ğŸ“‹ Preview Dataset")
st.dataframe(filtered, use_container_width=True)

csv = filtered.to_csv(index=False).encode("utf-8")
st.download_button(
    "â¬‡ Download Filtered Dataset",
    data=csv,
    file_name="Filtered_Promotions.csv",
    mime="text/csv"
)
